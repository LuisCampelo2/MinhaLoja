{% extends "home/base.html" %}
{% block search_bar %}{% endblock search_bar %}
{% block content %}

<h1>Pagar com Stripe</h1>
<form id="payment-form">
    {% csrf_token %}
    <div id="card-element"></div>
    <h1>Total a Pagar: {{ total|floatformat:2 }}</h1>
    <button type="submit" id="submit-button">Pagar</button>
</form>

<script>
    const stripe = Stripe("{{ stripe_publishable_key }}");  // Chave pública
    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit-button');

    // Criação de elementos do Stripe
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');

    // Passando o total de forma segura
    const totalAmount = {{ total|floatformat:2|default:"0" }};  // Garante que seja um número e define 0 caso não tenha valor

    form.addEventListener('submit', async (e) => {
        e.preventDefault();  // Impede o envio tradicional do formulário

        // Desabilita o botão para evitar múltiplos cliques
        submitButton.disabled = true;

        // Envia uma requisição POST para criar o PaymentIntent e pegar o client_secret
        const response = await fetch("/create_payment/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",  // Token CSRF para segurança
            },
            body: JSON.stringify({ total: totalAmount }),  // Envia o total de forma segura
        });

        const data = await response.json();

        if (data.client_secret) {
            // Usando o client_secret retornado para confirmar o pagamento
            const {error, paymentIntent} = await stripe.confirmCardPayment(data.client_secret, {
                payment_method: {
                    card: cardElement,
                },
            });

            if (error) {
                alert(error.message);
            } else {
                alert("Pagamento realizado com sucesso!");
            }
        } else {
            alert("Erro ao criar o pagamento. Tente novamente.");
        }

        // Habilita o botão novamente
        submitButton.disabled = false;
    });
</script>

{% endblock content %}








